<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Financeiro – Contas a Receber & Pagar</title>
<style>
  :root{
    --bg:#0b1020; --card:#0f172a; --soft:#1e293b; --muted:#94a3b8; --text:#e5e7eb; --acc:#f26722;
    --ring:rgba(242,103,34,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:18px 16px;border-bottom:1px solid var(--soft);position:sticky;top:0;background:linear-gradient(180deg,#0b1020 0%, rgba(11,16,32,.8) 100%);backdrop-filter:saturate(140%) blur(2px);z-index:10}
  .container{max-width:1200px;margin:0 auto;padding:0 12px}
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:13px}
  
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .control{background:var(--card);border:1px solid var(--soft);border-radius:12px;padding:8px 10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input[type=file],select,input[type=date],input[type=text],input[type=number]{
    background:#0b1328;color:var(--text);border:1px solid var(--soft);border-radius:10px;padding:8px 10px;outline:none
  }
  input[type=text]::placeholder{color:#6b7789}
  .btn{background:var(--acc);color:#111;padding:9px 12px;border:none;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#0b1328;color:var(--text);border:1px solid var(--soft)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{padding:6px 10px;border:1px solid var(--soft);border-radius:999px;font-size:12px;color:var(--muted)}
  
  main{max-width:1200px;margin:16px auto;padding:0 12px}
  .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:var(--card);border:1px solid var(--soft);border-radius:14px;padding:12px}
  .kpi{grid-column:span 3}
  .kpi .title{font-size:12px;color:var(--muted)}
  .kpi .value{font-size:20px;font-weight:700;margin-top:4px}
  .kpi .hint{font-size:11px;color:var(--muted)}
  
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:18px 0}
  .tab{padding:8px 12px;border:1px solid var(--soft);border-radius:999px;background:#0b1328;color:var(--text);cursor:pointer;font-weight:600}
  .tab.active{background:var(--acc);color:#111;border-color:transparent}
  
  .legend{display:flex;gap:12px;flex-wrap:wrap}
  .legend .item{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--acc);box-shadow:0 0 0 3px var(--ring)}
  
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid var(--soft);padding:8px;vertical-align:top}
  th{position:sticky;top:0;background:#0f172a;z-index:1}
  tbody tr:hover{background:#0b1328}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .grow{flex:1}
  .right{margin-left:auto}
  .status-aber{color:#ffd27d}
  .status-atra{color:#ff9b9b}
  .status-liq{color:#98ecb2}
  .nowrap{white-space:nowrap}
  
  .foot{margin-top:10px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Dashboard Financeiro – Receber & Pagar</h1>
      <div class="sub">Carregue o <b>CSV unificado</b> (Receber + Pagar) e analise por abas. Funciona offline.</div>
      <div class="controls">
        <div class="control">
          <label>CSV Unificado</label>
          <input id="fileCsv" type="file" accept=".csv,text/csv" />
        </div>
        <div class="control">
          <label>Período base</label>
          <select id="baseTempo">
            <option value="venc">Vencimento</option>
            <option value="emiss">Emissão</option>
            <option value="pag">Pagamento</option>
          </select>
        </div>
        <div class="control">
          <label>De</label>
          <input id="dtIni" type="date" />
        </div>
        <div class="control">
          <label>Até</label>
          <input id="dtFim" type="date" />
        </div>
        <div class="control">
          <label>Tipo</label>
          <select id="fTipo">
            <option value="">Ambos</option>
            <option value="Receber">Receber</option>
            <option value="Pagar">Pagar</option>
          </select>
        </div>
        <div class="control">
          <label>Situação</label>
          <select id="fSit">
            <option value="">Todas</option>
            <option value="Aberto">Aberto</option>
            <option value="Atrasado">Atrasado</option>
            <option value="Liquidado">Liquidado</option>
          </select>
        </div>
        <div class="control">
          <label>Documento</label>
          <select id="fDoc">
            <option value="">Todos</option>
            <option value="CC">Cartão de Crédito</option>
            <option value="CD">Cartão de Débito</option>
            <option value="PIX">Pix</option>
            <option value="BL">Boleto</option>
            <option value="NF">Nota Fiscal</option>
            <option value="DI">Dinheiro</option>
          </select>
        </div>
        <div class="control grow">
          <label>Busca (Devedor/Beneficiado/Descrição)</label>
          <input id="fBusca" type="text" placeholder="Digite para filtrar..." />
        </div>
        <div class="control">
          <label>&nbsp;</label>
          <button id="btnExport" class="btn secondary">Exportar CSV (visão atual)</button>
        </div>
        <div class="pill" id="status">Aguardando CSV…</div>
      </div>
    </div>
  </header>

  <main>
    <section class="kpis">
      <div class="card kpi"><div class="title">Saldo Previsto do Período</div><div class="value" id="kPrev">—</div><div class="hint">Soma de Receber − Pagar (base no período)</div></div>
      <div class="card kpi"><div class="title">Realizado no Período</div><div class="value" id="kReal">—</div><div class="hint">Pagamentos/Recebimentos com data na janela</div></div>
      <div class="card kpi"><div class="title">A Receber em Aberto</div><div class="value" id="kARAberto">—</div><div class="hint">Inclui atrasados</div></div>
      <div class="card kpi"><div class="title">A Pagar em Aberto</div><div class="value" id="kAPAberto">—</div><div class="hint">Inclui atrasados</div></div>
    </section>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="geral">Visão Geral</button>
      <button class="tab" data-tab="receber">Receber</button>
      <button class="tab" data-tab="pagar">Pagar</button>
      <button class="tab" data-tab="aging">Aging & Risco</button>
      <button class="tab" data-tab="planos">Planos & Centros</button>
      <button class="tab" data-tab="detalhe">Detalhes</button>
    </div>

    <section id="tab-geral" class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <h3 style="margin:0">Resumo por mês (base do período)</h3>
        <div class="legend">
          <div class="item"><span class="dot"></span> <span>DOC.: CC, CD, PIX, BL, NF, DI</span></div>
          <div class="item"><span class="dot" style="background:#98ecb2"></span> <span>Situação: L = Liquidado</span></div>
          <div class="item"><span class="dot" style="background:#ffd27d"></span> <span>Situação: A = Aberto</span></div>
        </div>
      </div>
      <div id="tblMeses"></div>
      <div class="foot"><span id="infoMeses">—</span><span class="mono" id="now"></span></div>
    </section>

    <section id="tab-receber" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">A Receber</h3><span class="pill" id="recStats">—</span></div>
      <div id="tblReceber"></div>
    </section>

    <section id="tab-pagar" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">A Pagar</h3><span class="pill" id="pagStats">—</span></div>
      <div id="tblPagar"></div>
    </section>

    <section id="tab-aging" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">Aging – Títulos em Aberto (faixas de atraso)</h3><span class="pill" id="agingStats">—</span></div>
      <div id="tblAging"></div>
      <h4>Top Devedores / Fornecedores (em aberto)</h4>
      <div class="row" style="gap:12px">
        <div class="grow" id="tblTopDev"></div>
        <div class="grow" id="tblTopFor"></div>
      </div>
    </section>

    <section id="tab-planos" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">Planos de Contas</h3><span class="pill" id="planStats">—</span></div>
      <div id="tblPlanos"></div>
      <h4>Centros de Contas</h4>
      <div id="tblCentros"></div>
    </section>

    <section id="tab-detalhe" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">Detalhamento</h3><span class="pill" id="detStats">—</span></div>
      <div id="tblDetalhe"></div>
    </section>
  </main>

<script>
// ====== Helpers ======
const DOC_MAP = { CC:"Cartão de Crédito", CD:"Cartão de Débito", PIX:"Pix", BL:"Boleto", NF:"Nota Fiscal", DI:"Dinheiro" };
const SIT_MAP = { L:"Liquidado", A:"Aberto" };

const fmtBRL = (n)=> isFinite(n) ? n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '—';
const fmtInt = (n)=> isFinite(n) ? n.toLocaleString('pt-BR') : '—';
const pad2 = (x)=> String(x).padStart(2,'0');
const fmtDate = (d)=> d? `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}` : '';
const fmtDateBR = (d)=> d? `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}` : '';

function parseDateFlexible(s){
  if(!s) return null;
  const t = String(s).trim();
  if(!t || t==='-' ) return null;
  // ISO
  if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(t)){
    const d = new Date(t);
    return isNaN(d)? null : d;
  }
  // BR dd/mm/aaaa
  const m = t.match(/^([0-9]{1,2})\D([0-9]{1,2})\D([0-9]{2,4})/);
  if(m){
    const dd = +m[1], mm = +m[2], yy = +m[3];
    const yyyy = yy<100 ? (yy+2000) : yy;
    const d = new Date(yyyy, mm-1, dd);
    return isNaN(d)? null : d;
  }
  const d = new Date(t);
  return isNaN(d)? null : d;
}

function parseNumBR(s){
  if(s==null) return null;
  let t = String(s).trim();
  if(!t || t==='-' ) return null;
  t = t.replace(/[^0-9,.-]/g,''); // remove símbolos
  // se tem vírgula e ponto, assume BR: 1.234,56
  if(/,/.test(t)){
    t = t.replace(/\./g,'').replace(/,/g,'.');
  }
  const v = parseFloat(t);
  return isNaN(v)? null : v;
}

function detectDelimiter(sample){
  const seg = sample.split(/\r?\n/).slice(0,5).join('\n');
  const sc = (seg.match(/;/g)||[]).length, cc=(seg.match(/,/g)||[]).length;
  return sc>cc? ';' : ',';
}

function parseCSV(text, delimiter){
  delimiter = delimiter || detectDelimiter(text);
  const rows=[]; let i=0, field="", row=[], inQ=false;
  const pushF=()=>{row.push(field); field=""};
  const pushR=()=>{rows.push(row); row=[]};
  while(i<text.length){ const ch=text[i];
    if(inQ){
      if(ch==='"'){
        if(text[i+1]==='"'){ field+='"'; i++; } else { inQ=false; }
      } else field+=ch;
    } else {
      if(ch==='"') inQ=true;
      else if(ch===delimiter) pushF();
      else if(ch==='\r'){} 
      else if(ch==='\n'){ pushF(); pushR(); }
      else field+=ch;
    }
    i++;
  }
  if(field.length>0||row.length>0){ pushF(); pushR(); }
  while(rows.length && rows[rows.length-1].every(c=>String(c).trim()==="")) rows.pop();
  if(!rows.length) return {headers:[], data:[]};
  const headers = rows[0];
  const data = rows.slice(1).map(r=>{ const o={}; headers.forEach((h,idx)=>o[h]=r[idx]??""); return o; });
  return {headers,data};
}

const norm = (s)=> String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();

function headerIndex(headers, label){
  const tgt = norm(label).replace(/[\.-_/]/g,'');
  for(let i=0;i<headers.length;i++){
    const h = norm(headers[i]).replace(/[\.-_/]/g,'');
    if(h===tgt) return i;
  }
  for(let i=0;i<headers.length;i++){
    const h = norm(headers[i]).replace(/[\.-_/]/g,'');
    if(h.startsWith(tgt)) return i;
  }
  return -1;
}

function makeTable(headers, rows, opts={}){
  const container = document.createElement('div');
  container.style.maxHeight = opts.maxHeight || '420px';
  container.style.overflow = 'auto';
  let html = '<table><thead><tr>';
  headers.forEach((h,idx)=>{
    html += `<th data-idx="${idx}" class="sortable">${h}</th>`;
  });
  html += '</tr></thead><tbody>';
  rows.forEach(r=>{
    html += '<tr>' + headers.map(h=>`<td>${r[h]??''}</td>`).join('') + '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
  return container;
}

function groupBy(arr, keyFn){
  const m = new Map();
  for(const it of arr){ const k = keyFn(it); m.set(k, (m.get(k)||[]).concat([it])); }
  return m;
}

// ====== State ======
let RAW={headers:[], data:[]};
let REG=[]; // registros normalizados

// ====== Normalização ======
function toRecord(row, headers){
  const get = (label)=>{
    const i = headerIndex(headers, label);
    return i>=0 ? row[headers[i]] : '';
  };
  const tipo0 = get('Tipo')||'';
  const tipo = tipo0 || (get('Devedor')? 'Receber' : (get('Beneficiado')? 'Pagar' : ''));
  const docCode = String(get('Doc.')||'').toUpperCase().trim();
  const docLabel = DOC_MAP[docCode] || docCode || '';
  const sitCode = String(get('Situação')||'').toUpperCase().trim();
  const sitLabel = SIT_MAP[sitCode] || sitCode || '';

  const emissao = parseDateFlexible(get('Emissão'));
  const venc = parseDateFlexible(get('Vencimento'));
  const pag = parseDateFlexible(get('Pagamento'));

  // valores
  const vValor = parseNumBR(get('Valor'));
  const vTot = parseNumBR(get('Total'));
  const vTLiq = parseNumBR(get('Total Liquido'));
  const vTRec = parseNumBR(get('Total a Receber'));

  const isRec = tipo==='Receber';
  const isPag = tipo==='Pagar';

  const valorPrev = isRec ? (vTRec ?? vTLiq ?? vValor) : (vTot ?? vValor);
  const valorReal = (pag? (isRec ? (vTLiq ?? vValor) : (vValor ?? vTot)) : null);

  // status padronizado
  let statusPad = sitLabel||''; // Aberto ou Liquidado se vier mapeado
  if(statusPad===''){ statusPad = pag? 'Liquidado' : 'Aberto'; }

  const hoje = new Date(); hoje.setHours(0,0,0,0);
  let diasAtraso = null, diasAteVenc = null;
  if(venc){ diasAteVenc = Math.round((venc - (emissao||venc))/86400000); }
  if(statusPad==='Aberto'){
    if(venc){
      const diff = Math.round((hoje - venc)/86400000);
      diasAtraso = Math.max(0, diff);
      if(diasAtraso>0) statusPad = 'Atrasado';
    }
  } else if(pag && venc){
    const diff = Math.round((pag - venc)/86400000);
    diasAtraso = Math.max(0, diff);
  }

  const contraparte = isRec ? (get('Devedor')||'') : (get('Beneficiado')||'');
  const plano = get('Plano de contas')||'';
  const centro = get('Centro de contas')||'';
  const desc = get('Descrição')||'';

  return {
    tipo, docCode, docLabel, sitCode, sitLabel: statusPad,
    emissao, venc, pag,
    valorPrev, valorReal,
    contraparte, plano, centro, desc,
    diasAtraso, diasAteVenc,
    mes_emiss: emissao? `${emissao.getFullYear()}-${pad2(emissao.getMonth()+1)}` : '',
    mes_venc: venc? `${venc.getFullYear()}-${pad2(venc.getMonth()+1)}` : '',
    mes_pag: pag? `${pag.getFullYear()}-${pad2(pag.getMonth()+1)}` : ''
  };
}

// ====== Render Utils ======
function renderTable(containerId, headers, rows){
  const c = document.getElementById(containerId);
  c.innerHTML = '';
  c.appendChild(makeTable(headers, rows));
}

function sum(arr, sel){ let s=0; for(const x of arr){ const v=sel(x); if(typeof v==='number' && isFinite(v)) s+=v; } return s; }

function applyFilters(base, dtIni, dtFim, tipo, sit, doc, busca){
  return REG.filter(r=>{
    // base de período
    let dBase = r.venc; if(base==='emiss') dBase=r.emissao; if(base==='pag') dBase=r.pag;
    if(dtIni && (!dBase || dBase<dtIni)) return false;
    if(dtFim && (!dBase || dBase>dtFim)) return false;
    if(tipo && r.tipo!==tipo) return false;
    if(sit && r.sitLabel!==sit) return false;
    if(doc && r.docCode!==doc) return false;
    if(busca){
      const q = norm(busca);
      const hay = [r.contraparte, r.desc, r.plano, r.centro].map(norm).join(' ');
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}

function makeMesesResumo(rows, base){
  const key = base==='emiss'?'mes_emiss': base==='pag'?'mes_pag':'mes_venc';
  const g = groupBy(rows, r=> r[key]||'(sem mês)');
  const meses = Array.from(g.keys()).sort();
  const out = [];
  for(const m of meses){
    const arr = g.get(m);
    const recPrev = sum(arr.filter(r=>r.tipo==='Receber'), r=> r.valorPrev||0);
    const pagPrev = sum(arr.filter(r=>r.tipo==='Pagar'), r=> r.valorPrev||0);
    const recReal = sum(arr.filter(r=>r.tipo==='Receber'), r=> r.valorReal||0);
    const pagReal = sum(arr.filter(r=>r.tipo==='Pagar'), r=> r.valorReal||0);
    out.push({
      Mês:m,
      "Previsto Receber": fmtBRL(recPrev),
      "Previsto Pagar": fmtBRL(pagPrev),
      "Saldo Previsto": fmtBRL(recPrev - pagPrev),
      "Realizado Receber": fmtBRL(recReal),
      "Realizado Pagar": fmtBRL(pagReal),
      "Saldo Realizado": fmtBRL(recReal - pagReal),
      "Qtde": fmtInt(arr.length)
    });
  }
  return out;
}

function makeReceberTable(rows){
  const headers = ["Vencimento","Devedor","Doc.","Situação","Emissão","Pagamento","Valor Previsto","Valor Realizado","Atraso (dias)","Descrição","Plano","Centro"];
  const out = rows.filter(r=>r.tipo==='Receber').map(r=>({
    "Vencimento": r.venc? fmtDateBR(r.venc):'',
    "Devedor": r.contraparte||'',
    "Doc.": r.docCode? `${r.docCode} – ${r.docLabel}`:'',
    "Situação": r.sitLabel,
    "Emissão": r.emissao? fmtDateBR(r.emissao):'',
    "Pagamento": r.pag? fmtDateBR(r.pag):'',
    "Valor Previsto": fmtBRL(r.valorPrev||0),
    "Valor Realizado": r.valorReal!=null? fmtBRL(r.valorReal):'',
    "Atraso (dias)": (r.sitLabel==='Atrasado' && r.diasAtraso!=null)? r.diasAtraso : (r.diasAtraso!=null? r.diasAtraso: ''),
    "Descrição": r.desc||'',
    "Plano": r.plano||'',
    "Centro": r.centro||''
  }));
  return {headers, rows: out};
}

function makePagarTable(rows){
  const headers = ["Vencimento","Beneficiado","Doc.","Situação","Emissão","Pagamento","Valor Previsto","Valor Realizado","Atraso (dias)","Descrição","Plano","Centro"];
  const out = rows.filter(r=>r.tipo==='Pagar').map(r=>({
    "Vencimento": r.venc? fmtDateBR(r.venc):'',
    "Beneficiado": r.contraparte||'',
    "Doc.": r.docCode? `${r.docCode} – ${r.docLabel}`:'',
    "Situação": r.sitLabel,
    "Emissão": r.emissao? fmtDateBR(r.emissao):'',
    "Pagamento": r.pag? fmtDateBR(r.pag):'',
    "Valor Previsto": fmtBRL(r.valorPrev||0),
    "Valor Realizado": r.valorReal!=null? fmtBRL(r.valorReal):'',
    "Atraso (dias)": (r.sitLabel==='Atrasado' && r.diasAtraso!=null)? r.diasAtraso : (r.diasAtraso!=null? r.diasAtraso: ''),
    "Descrição": r.desc||'',
    "Plano": r.plano||'',
    "Centro": r.centro||''
  }));
  return {headers, rows: out};
}

function makeAging(rows){
  const abertos = rows.filter(r=> r.sitLabel==='Aberto' || r.sitLabel==='Atrasado');
  function faixa(d){
    if(d==null) return 'Sem venc.';
    if(d<=0) return '0';
    if(d<=7) return '0–7';
    if(d<=15) return '8–15';
    if(d<=30) return '16–30';
    if(d<=60) return '31–60';
    if(d<=90) return '61–90';
    return '>90';
  }
  const g = groupBy(abertos, r=> faixa(r.diasAtraso));
  const fxs = ['0','0–7','8–15','16–30','31–60','61–90','>90','Sem venc.'];
  const rowsOut=[];
  for(const f of fxs){
    const arr = g.get(f)||[];
    const ar = arr.filter(r=>r.tipo==='Receber');
    const ap = arr.filter(r=>r.tipo==='Pagar');
    rowsOut.push({
      "Faixa": f,
      "Receber (qtde)": fmtInt(ar.length),
      "Receber (valor)": fmtBRL(sum(ar,x=>x.valorPrev||0)),
      "Pagar (qtde)": fmtInt(ap.length),
      "Pagar (valor)": fmtBRL(sum(ap,x=>x.valorPrev||0))
    });
  }
  return {headers:["Faixa","Receber (qtde)","Receber (valor)","Pagar (qtde)","Pagar (valor)"], rows:rowsOut};
}

function topContrapartes(rows, tipo){
  const abertos = rows.filter(r=> (r.sitLabel==='Aberto'||r.sitLabel==='Atrasado') && r.tipo===tipo);
  const g = groupBy(abertos, r=> r.contraparte||'(sem nome)');
  const arr = Array.from(g.entries()).map(([k,v])=>({
    nome:k, qtde:v.length, valor: sum(v,x=>x.valorPrev||0), atrasoMed: Math.round((v.reduce((a,x)=>a+(x.diasAtraso||0),0))/(v.length||1))
  }))
  .sort((a,b)=> b.valor - a.valor)
  .slice(0,10)
  .map(x=>({
    "Contraparte": x.nome,
    "Qtde": fmtInt(x.qtde),
    "Valor em aberto": fmtBRL(x.valor),
    "Atraso médio (dias)": fmtInt(x.atrasoMed)
  }));
  return {headers:["Contraparte","Qtde","Valor em aberto","Atraso médio (dias)"], rows:arr};
}

function porPlano(rows){
  const g = groupBy(rows, r=> r.plano||'(sem plano)');
  const arr = Array.from(g.entries()).map(([k,v])=>({
    Plano:k,
    "Previsto Receber": fmtBRL(sum(v.filter(x=>x.tipo==='Receber'), x=>x.valorPrev||0)),
    "Previsto Pagar": fmtBRL(sum(v.filter(x=>x.tipo==='Pagar'), x=>x.valorPrev||0)),
    "Realizado": fmtBRL(sum(v, x=>x.valorReal||0)),
    "Qtde": fmtInt(v.length)
  })).sort((a,b)=>{
    const av = parseNumBR(a["Previsto Receber"]) - parseNumBR(a["Previsto Pagar"]);
    const bv = parseNumBR(b["Previsto Receber"]) - parseNumBR(b["Previsto Pagar"]);
    return bv-av;
  });
  return {headers:["Plano","Previsto Receber","Previsto Pagar","Realizado","Qtde"], rows:arr};
}

function porCentro(rows){
  const g = groupBy(rows, r=> r.centro||'(sem centro)');
  const arr = Array.from(g.entries()).map(([k,v])=>({
    Centro:k,
    "Previsto Receber": fmtBRL(sum(v.filter(x=>x.tipo==='Receber'), x=>x.valorPrev||0)),
    "Previsto Pagar": fmtBRL(sum(v.filter(x=>x.tipo==='Pagar'), x=>x.valorPrev||0)),
    "Realizado": fmtBRL(sum(v, x=>x.valorReal||0)),
    "Qtde": fmtInt(v.length)
  })).sort((a,b)=>{
    const av = parseNumBR(a["Previsto Receber"]) - parseNumBR(a["Previsto Pagar"]);
    const bv = parseNumBR(b["Previsto Receber"]) - parseNumBR(b["Previsto Pagar"]);
    return bv-av;
  });
  return {headers:["Centro","Previsto Receber","Previsto Pagar","Realizado","Qtde"], rows:arr};
}

function detalhe(rows){
  const headers = ["Tipo","Doc.","Situação","Emissão","Vencimento","Pagamento","Contraparte","Descrição","Plano","Centro","Valor Previsto","Valor Realizado","Atraso (dias)"];
  const out = rows.map(r=>({
    "Tipo": r.tipo,
    "Doc.": r.docCode? `${r.docCode} – ${r.docLabel}`:'',
    "Situação": r.sitLabel,
    "Emissão": r.emissao? fmtDateBR(r.emissao):'',
    "Vencimento": r.venc? fmtDateBR(r.venc):'',
    "Pagamento": r.pag? fmtDateBR(r.pag):'',
    "Contraparte": r.contraparte||'',
    "Descrição": r.desc||'',
    "Plano": r.plano||'',
    "Centro": r.centro||'',
    "Valor Previsto": fmtBRL(r.valorPrev||0),
    "Valor Realizado": r.valorReal!=null? fmtBRL(r.valorReal):'',
    "Atraso (dias)": r.diasAtraso!=null? r.diasAtraso: ''
  }));
  return {headers, rows: out};
}

function exportCSV(headers, rows){
  const delim = ';';
  const esc = (v)=>{
    let s = v==null? '' : String(v);
    const needQ = /[";\n\r]/.test(s);
    s = s.replace(/"/g,'""');
    return needQ? `"${s}"` : s;
  };
  const head = headers.map(esc).join(delim);
  const body = rows.map(r=> headers.map(h=>esc(r[h])).join(delim)).join('\r\n');
  return head + '\r\n' + body + '\r\n';
}

// ====== UI Bindings ======
const elFile = document.getElementById('fileCsv');
const elBase = document.getElementById('baseTempo');
const elIni = document.getElementById('dtIni');
const elFim = document.getElementById('dtFim');
const elTipo = document.getElementById('fTipo');
const elSit = document.getElementById('fSit');
const elDoc = document.getElementById('fDoc');
const elBusca = document.getElementById('fBusca');
const elStatus = document.getElementById('status');
const elNow = document.getElementById('now');

const kPrev = document.getElementById('kPrev');
const kReal = document.getElementById('kReal');
const kAR = document.getElementById('kARAberto');
const kAP = document.getElementById('kAPAberto');

function setStatus(msg, ok){
  elStatus.textContent = msg;
  elStatus.style.borderColor = ok? 'rgba(152,236,178,.5)' : 'var(--soft)';
}

function refresh(){
  if(!REG.length){ setStatus('Aguardando CSV…'); return; }
  // datas
  const di = elIni.value? new Date(elIni.value) : null; if(di) di.setHours(0,0,0,0);
  const df = elFim.value? new Date(elFim.value) : null; if(df) df.setHours(23,59,59,999);
  const base = elBase.value; const tipo = elTipo.value; const sit = elSit.value; const doc = elDoc.value; const busca = elBusca.value.trim();

  const rows = applyFilters(base, di, df, tipo, sit, doc, busca);

  // KPIs
  const prevSigned = sum(rows, r=> (r.valorPrev||0) * (r.tipo==='Receber'? 1 : -1));
  const realSigned = sum(rows, r=> (r.valorReal||0) * (r.tipo==='Receber'? 1 : -1));
  const aRecAberto = sum(REG.filter(r=> r.tipo==='Receber' && (r.sitLabel==='Aberto'||r.sitLabel==='Atrasado')), r=> r.valorPrev||0);
  const aPagAberto = sum(REG.filter(r=> r.tipo==='Pagar' && (r.sitLabel==='Aberto'||r.sitLabel==='Atrasado')), r=> r.valorPrev||0);

  kPrev.textContent = fmtBRL(prevSigned);
  kReal.textContent = fmtBRL(realSigned);
  kAR.textContent = fmtBRL(aRecAberto);
  kAP.textContent = fmtBRL(aPagAberto);

  // Tabelas
  const meses = makeMesesResumo(rows, base);
  renderTable('tblMeses', Object.keys(meses[0]||{"Mês":"Mês"}), meses);
  document.getElementById('infoMeses').textContent = `${rows.length||0} lançamentos no período`;

  const rec = makeReceberTable(rows);
  renderTable('tblReceber', rec.headers, rec.rows);
  document.getElementById('recStats').textContent = `${rec.rows.length||0} linhas`;

  const pag = makePagarTable(rows);
  renderTable('tblPagar', pag.headers, pag.rows);
  document.getElementById('pagStats').textContent = `${pag.rows.length||0} linhas`;

  const ag = makeAging(rows);
  renderTable('tblAging', ag.headers, ag.rows);
  document.getElementById('agingStats').textContent = `Faixas calculadas sobre títulos em aberto/atrasado`;

  const pl = porPlano(rows);
  renderTable('tblPlanos', pl.headers, pl.rows);
  const ct = porCentro(rows);
  renderTable('tblCentros', ct.headers, ct.rows);
  document.getElementById('planStats').textContent = `${pl.rows.length} planos • ${ct.rows.length} centros`;

  const det = detalhe(rows);
  renderTable('tblDetalhe', det.headers, det.rows);
  document.getElementById('detStats').textContent = `${det.rows.length||0} linhas`;

  setStatus('Ok');
}

elFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f){ setStatus('Selecione um CSV.'); return; }
  setStatus('Lendo CSV…');
  const text = await f.text();
  const parsed = parseCSV(text);
  RAW = parsed;
  REG = parsed.data.map(row=> toRecord(row, parsed.headers));
  setStatus(`CSV carregado: ${parsed.data.length} linhas.` , true);
  refresh();
});

['change','keyup'].forEach(ev=>{
  elBase.addEventListener(ev, refresh);
  elIni.addEventListener(ev, refresh);
  elFim.addEventListener(ev, refresh);
  elTipo.addEventListener(ev, refresh);
  elSit.addEventListener(ev, refresh);
  elDoc.addEventListener(ev, refresh);
  elBusca.addEventListener(ev, ()=>{ clearTimeout(window.___t); window.___t=setTimeout(refresh,200); });
});

// Export atual
 document.getElementById('btnExport').addEventListener('click', ()=>{
   const di = elIni.value? new Date(elIni.value) : null; if(di) di.setHours(0,0,0,0);
   const df = elFim.value? new Date(elFim.value) : null; if(df) df.setHours(23,59,59,999);
   const base = elBase.value; const tipo = elTipo.value; const sit = elSit.value; const doc = elDoc.value; const busca = elBusca.value.trim();
   const rows = applyFilters(base, di, df, tipo, sit, doc, busca);
   const det = detalhe(rows);
   const csv = exportCSV(det.headers, det.rows);
   const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url; a.download = 'visao_filtrada.csv'; a.click();
   setTimeout(()=> URL.revokeObjectURL(url), 1000);
 });

// Tabs
const tabsEl = document.getElementById('tabs');
const sections = {
  geral: document.getElementById('tab-geral'),
  receber: document.getElementById('tab-receber'),
  pagar: document.getElementById('tab-pagar'),
  aging: document.getElementById('tab-aging'),
  planos: document.getElementById('tab-planos'),
  detalhe: document.getElementById('tab-detalhe')
};

tabsEl.addEventListener('click', (e)=>{
  if(e.target.classList.contains('tab')){
    const tab = e.target.getAttribute('data-tab');
    Array.from(tabsEl.children).forEach(x=> x.classList.remove('active'));
    e.target.classList.add('active');
    Object.keys(sections).forEach(k=> sections[k].style.display='none');
    sections[tab].style.display='block';
  }
});

// now label
(function(){
  const d = new Date();
  elNow.textContent = `Atualizado ${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
})();
</script>
</body>
</html>

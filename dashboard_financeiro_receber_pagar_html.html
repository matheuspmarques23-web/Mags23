<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Financeiro – Contas a Receber & Pagar</title>
<style>
  :root{
    --bg:#0b1020; --card:#0f172a; --soft:#1e293b; --muted:#94a3b8; --text:#e5e7eb; --acc:#f26722;
    --ring:rgba(242,103,34,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:18px 16px;border-bottom:1px solid var(--soft);position:sticky;top:0;background:linear-gradient(180deg,#0b1020 0%, rgba(11,16,32,.8) 100%);backdrop-filter:saturate(140%) blur(2px);z-index:10}
  .container{max-width:1200px;margin:0 auto;padding:0 12px}
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:13px}
  
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .control{background:var(--card);border:1px solid var(--soft);border-radius:12px;padding:8px 10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input[type=file],select,input[type=date],input[type=text],input[type=number]{
    background:#0b1328;color:var(--text);border:1px solid var(--soft);border-radius:10px;padding:8px 10px;outline:none
  }
  input[type=text]::placeholder{color:#6b7789}
  .btn{background:var(--acc);color:#111;padding:9px 12px;border:none;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#0b1328;color:var(--text);border:1px solid var(--soft)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{padding:6px 10px;border:1px solid var(--soft);border-radius:999px;font-size:12px;color:var(--muted)}
  
  main{max-width:1200px;margin:16px auto;padding:0 12px}
  .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:var(--card);border:1px solid var(--soft);border-radius:14px;padding:12px}
  .kpi{grid-column:span 3}
  .kpi .title{font-size:12px;color:var(--muted)}
  .kpi .value{font-size:20px;font-weight:700;margin-top:4px}
  .kpi .hint{font-size:11px;color:var(--muted)}
  
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:18px 0}
  .tab{padding:8px 12px;border:1px solid var(--soft);border-radius:999px;background:#0b1328;color:var(--text);cursor:pointer;font-weight:600}
  .tab.active{background:var(--acc);color:#111;border-color:transparent}
  
  .legend{display:flex;gap:12px;flex-wrap:wrap}
  .legend .item{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--acc);box-shadow:0 0 0 3px var(--ring)}
  
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid var(--soft);padding:8px;vertical-align:top}
  th{position:sticky;top:0;background:#0f172a;z-index:1}
  tbody tr:hover{background:#0b1328}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .grow{flex:1}
  .right{margin-left:auto}
  .status-aber{color:#ffd27d}
  .status-atra{color:#ff9b9b}
  .status-liq{color:#98ecb2}
  .nowrap{white-space:nowrap}
  
  .foot{margin-top:10px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
  /* === MODAL === */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:30}
  .modal.hidden{display:none}
  .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
  .modal-card{position:relative;background:var(--card);border:1px solid var(--soft);border-radius:14px;max-width:640px;width:90%;max-height:90%;overflow:auto;padding:16px;display:flex;flex-direction:column}
  .modal-header,.modal-footer{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .modal-body{flex:1;overflow:auto;padding:8px 0}
  .icon-btn{background:none;border:none;color:var(--text);font-size:20px;cursor:pointer}
  .modal-card button{margin-top:0}
  /* === SORT */
  th[data-key]{cursor:pointer;user-select:none;position:relative;padding-right:16px}
  th.sort-asc::after{content:'\25B2';position:absolute;right:4px}
  th.sort-desc::after{content:'\25BC';position:absolute;right:4px}
  /* === CHARTS PRO */
  .chart-tooltip{position:absolute;background:var(--card);border:1px solid var(--soft);border-radius:6px;padding:4px 6px;font-size:11px;pointer-events:none;z-index:40;white-space:nowrap}
  .chart-tooltip.hidden{display:none}
  canvas{touch-action:pan-y}
  /* === CHART MODAL */
  #chartModal.modal{position:fixed;inset:0;z-index:9999}
  #chartModal .modal-backdrop{position:absolute;inset:0;background:#0009}
  #chartModal .modal-card{position:absolute;inset:auto;top:5vh;left:50%;transform:translateX(-50%);width:min(90vw,1100px);max-height:90vh;background:var(--bg);color:var(--text);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:12px}
  #chartModal .modal-body{overflow:auto}
  #chartModal.hidden{display:none}
</style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Dashboard Financeiro – Receber & Pagar</h1>
      <div class="sub">Carregue o <b>CSV unificado</b> (Receber + Pagar) e analise por abas. Funciona offline.</div>
      <div class="controls">
        <div class="control">
          <label>CSV Unificado</label>
          <input id="fileCsv" type="file" accept=".csv,text/csv" />
        </div>
        <div class="control">
          <label>Período base</label>
          <select id="baseTempo">
            <option value="venc">Vencimento</option>
            <option value="emiss">Emissão</option>
            <option value="pag">Pagamento</option>
          </select>
        </div>
        <div class="control">
          <label>De</label>
          <input id="dtIni" type="date" />
        </div>
        <div class="control">
          <label>Até</label>
          <input id="dtFim" type="date" />
        </div>
        <div class="control">
          <label>Tipo</label>
          <select id="fTipo">
            <option value="">Ambos</option>
            <option value="Receber">Receber</option>
            <option value="Pagar">Pagar</option>
          </select>
        </div>
        <div class="control">
          <label>Situação</label>
          <select id="fSit">
            <option value="">Todas</option>
            <option value="Aberto">Aberto</option>
            <option value="Atrasado">Atrasado</option>
            <option value="Liquidado">Liquidado</option>
          </select>
        </div>
        <div class="control">
          <label>Documento</label>
          <select id="fDoc">
            <option value="">Todos</option>
            <option value="CC">Cartão de Crédito</option>
            <option value="CD">Cartão de Débito</option>
            <option value="PIX">Pix</option>
            <option value="BL">Boleto</option>
            <option value="NF">Nota Fiscal</option>
            <option value="DI">Dinheiro</option>
          </select>
        </div>
        <div class="control grow">
          <label>Busca (Devedor/Beneficiado/Descrição)</label>
          <input id="fBusca" type="text" placeholder="Digite para filtrar..." />
        </div>
        <div class="control">
          <label>&nbsp;</label>
          <button id="btnExport" class="btn secondary">Exportar CSV (visão atual)</button>
        </div>
        <div class="pill" id="status">Aguardando CSV…</div>
      </div>
    </div>
  </header>

  <main>
    <section class="kpis">
      <div class="card kpi"><div class="title">Resultado</div><div class="value" id="kResultado">—</div><div class="hint">Receber − Pagar</div></div>
      <div class="card kpi"><div class="title">Contas a pagar</div><div class="value" id="kPagar">—</div><div class="hint">Conforme base</div></div>
      <div class="card kpi"><div class="title">Contas a receber</div><div class="value" id="kReceber">—</div><div class="hint">Conforme base</div></div>
      <div class="card kpi"><div class="title">Lucratividade (%)</div><div class="value" id="kLucratividade">—</div><div class="hint">Resultado/Receber</div></div>
    </section>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="geral">Visão Geral</button>
      <button class="tab" data-tab="mensal">Mensal</button>
      <button class="tab" data-tab="receber">Receber</button>
      <button class="tab" data-tab="pagar">Pagar</button>
      <!-- === REMOVER AGING -->
      <button class="tab" data-tab="planos">Planos & Centros</button>
      <button class="tab" data-tab="detalhe">Detalhes</button>
      <button class="tab" data-tab="relcaixa">Relatório (Caixa)</button>
      <button class="tab" data-tab="diag">Diagnóstico</button>
    </div>

    <section id="tab-geral" class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <h3 style="margin:0">Resumo por mês (base do período)</h3>
        <div class="legend">
          <div class="item"><span class="dot"></span> <span>DOC.: CC, CD, PIX, BL, NF, DI</span></div>
          <div class="item"><span class="dot" style="background:#98ecb2"></span> <span>Situação: L = Liquidado</span></div>
          <div class="item"><span class="dot" style="background:#ffd27d"></span> <span>Situação: A = Aberto</span></div>
        </div>
      </div>
      <div id="tblMeses"></div>
      <!-- === Gráficos mensais === -->
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="card" style="flex:1;min-width:320px"><canvas id="chResMensal"></canvas></div>
        <div class="card" style="flex:1;min-width:320px"><canvas id="chPVSRMensal"></canvas></div>
        <div class="card" style="flex:1;min-width:320px"><canvas id="chResAcum"></canvas></div>
        <div class="card" style="flex:1;min-width:320px"><canvas id="chLucroMensal"></canvas></div>
      </div>
      <div class="foot"><span id="infoMeses">—</span><span class="mono" id="now"></span></div>
    </section>

    <!-- === Aba Mensal === -->
    <section id="tab-mensal" class="card" style="display:none">
      <div class="row" style="gap:8px;align-items:center">
        <label for="mensalMesSelect">Mês/Ano</label>
        <select id="mensalMesSelect"></select>
      </div>
      <section class="kpis" style="margin-top:12px">
        <div class="card kpi"><div class="title">Resultado</div><div class="value" id="kResM">—</div><div class="hint">Receber − Pagar</div></div>
        <div class="card kpi"><div class="title">Contas a pagar</div><div class="value" id="kPagarM">—</div><div class="hint">Conforme base</div></div>
        <div class="card kpi"><div class="title">Contas a receber</div><div class="value" id="kReceberM">—</div><div class="hint">Conforme base</div></div>
        <div class="card kpi"><div class="title">Lucratividade (%)</div><div class="value" id="kLucroM">—</div><div class="hint">Resultado/Receber</div></div>
      </section>
      <div class="row" style="margin-top:12px"><h3 style="margin:0">A Receber (mês)</h3><span class="pill" id="recMensalStats">—</span></div>
      <div id="tblMensalRec"></div>
      <div class="row" style="margin-top:16px"><h3 style="margin:0">A Pagar (mês)</h3><span class="pill" id="pagMensalStats">—</span></div>
      <div id="tblMensalPag"></div>
    </section>

    <section id="tab-receber" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">A Receber</h3><span class="pill" id="recStats">—</span></div>
      <div id="tblReceber"></div>
    </section>

    <section id="tab-pagar" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">A Pagar</h3><span class="pill" id="pagStats">—</span></div>
      <div id="tblPagar"></div>
    </section>

    <!-- === REMOVER AGING -->

    <section id="tab-planos" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">Planos de Contas</h3><span class="pill" id="planStats">—</span></div>
      <div id="tblPlanos"></div>
      <h4>Centros de Contas</h4>
      <div id="tblCentros"></div>
    </section>

    <section id="tab-detalhe" class="card" style="display:none">
      <div class="row"><h3 style="margin:0">Detalhamento</h3><span class="pill" id="detStats">—</span></div>
      <div id="tblDetalhe"></div>
    </section>

    <!-- === Relatório de Caixa === -->
    <section id="tab-relcaixa" class="card" style="display:none">
      <div class="row" style="align-items:center;gap:12px">
        <h3 style="margin:0">Relatório (Caixa)</h3>
        <div class="right" style="display:flex;align-items:center;gap:6px">
          <label for="saldoInicial">Saldo inicial (R$)</label>
          <input id="saldoInicial" type="number" value="0" step="0.01" style="width:120px" />
        </div>
      </div>
      <div id="tblRelCaixa"></div>
      <div class="foot"><span>Relatório sempre considera base Pagamento (regime de caixa).</span></div>
    </section>

    <!-- === Diagnóstico === -->
    <section id="tab-diag" class="card" style="display:none">
      <h3 style="margin:0">Diagnóstico</h3>
      <section class="kpis" style="margin-top:12px">
        <div class="card kpi"><div class="title">Linhas sem data na base selecionada</div><div class="value" id="dSemData">0</div><div class="hint">verificar lançamento no ERP</div></div>
        <div class="card kpi"><div class="title">DOC desconhecido</div><div class="value" id="dDoc">0</div><div class="hint">corrigir tipo de doc</div></div>
        <div class="card kpi"><div class="title">SIT desconhecida</div><div class="value" id="dSit">0</div><div class="hint">ajustar status</div></div>
        <div class="card kpi"><div class="title">Valores negativos/zerados</div><div class="value" id="dVal">0</div><div class="hint">rever valores</div></div>
        <div class="card kpi"><div class="title">Possíveis duplicidades</div><div class="value" id="dDup">0</div><div class="hint">evitar lançamentos repetidos</div></div>
      </section>
      <div class="row" style="flex-direction:column;gap:12px;margin-top:12px">
        <div id="diagSemData"></div>
        <div id="diagDoc"></div>
        <div id="diagSit"></div>
        <div id="diagVal"></div>
        <div id="diagDup"></div>
      </div>
    </section>
  </main>

  <!-- === MODAL === -->
  <div id="rowModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="rowModalTitle">
    <div class="modal-backdrop" data-close></div>
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="rowModalTitle">Detalhe do Lançamento</h3>
        <button class="icon-btn" id="rowModalClose" aria-label="Fechar">×</button>
      </div>
      <div class="modal-body" id="rowModalBody"></div>
      <div class="modal-footer">
        <button id="btnCopyModal">Copiar</button>
        <button id="btnCloseModal">Fechar</button>
      </div>
    </div>
  </div>
  <!-- === CHART MODAL -->
  <div id="chartModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="chartModalTitle">
    <div class="modal-backdrop" data-close></div>
    <div class="modal-card modal-wide">
      <div class="modal-header">
        <h3 id="chartModalTitle">Visualização do Gráfico</h3>
        <div class="modal-actions">
          <button id="btnChartDownload">Baixar PNG</button>
          <button id="btnChartCopyCSV">Copiar dados (CSV)</button>
          <button id="chartModalClose" aria-label="Fechar">×</button>
        </div>
      </div>
      <div class="modal-body">
        <canvas id="chartModalCanvas"></canvas>
      </div>
    </div>
  </div>

<script>
// ====== Helpers ======
const DOC_MAP = { CC:"Cartão de Crédito", CD:"Cartão de Débito", PIX:"Pix", BL:"Boleto", NF:"Nota Fiscal", DI:"Dinheiro" };
const SIT_MAP = { L:"Liquidado", A:"Aberto" };

const fmtBRL = (n)=> isFinite(n) ? n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '—';
const fmtCurrencyBR = fmtBRL; // === CHARTS PRO
// === CHARTS LEGÍVEIS
function fmtCurrencyCompactBR(n){
  const s=Math.sign(n)<0?'-':'';
  const v=Math.abs(n);
  if(v>=1_000_000) return `${s}R$ ${(v/1_000_000).toFixed(1).replace('.',',')} mi`;
  if(v>=1_000) return `${s}R$ ${(v/1_000).toFixed(1).replace('.',',')} mil`;
  return s + fmtCurrencyBR(v);
}
const fmtPercent = (n)=> isFinite(n)? n.toFixed(1).replace('.',',')+'%':'—';
const fmtInt = (n)=> isFinite(n) ? n.toLocaleString('pt-BR') : '—';
const pad2 = (x)=> String(x).padStart(2,'0');
const fmtDate = (d)=> d? `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}` : '';
const fmtDateBR = (d)=> d? `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}` : '';

function parseDateFlexible(s){
  if(!s) return null;
  const t=String(s).trim();
  if(!t||t==='-') return null;
  if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(t)){ const d=new Date(t); return isNaN(d)?null:d; }
  const m=t.match(/^([0-9]{1,2})\D([0-9]{1,2})\D([0-9]{2,4})/);
  if(m){ const dd=+m[1], mm=+m[2], yy=+m[3]; const yyyy=yy<100?(yy+2000):yy; const d=new Date(yyyy,mm-1,dd); return isNaN(d)?null:d; }
  const d=new Date(t); return isNaN(d)?null:d;
}

function parseNumBR(s){
  if(s==null) return null;
  let t=String(s).trim();
  if(!t||t==='-') return null;
  t=t.replace(/[^0-9,.-]/g,'');
  if(/,/.test(t)){ t=t.replace(/\./g,'').replace(/,/g,'.'); }
  const v=parseFloat(t);
  return isNaN(v)? null : v;
}

function detectDelimiter(sample){
  const seg=sample.split(/\r?\n/).slice(0,5).join('\n');
  const sc=(seg.match(/;/g)||[]).length, cc=(seg.match(/,/g)||[]).length;
  return sc>cc? ';' : ',';
}

function parseCSV(text, delimiter){
  delimiter = delimiter || detectDelimiter(text);
  const rows=[]; let i=0, field="", row=[], inQ=false;
  const pushF=()=>{row.push(field); field=""};
  const pushR=()=>{rows.push(row); row=[]};
  while(i<text.length){ const ch=text[i];
    if(inQ){
      if(ch==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else { inQ=false; } }
      else field+=ch;
    } else {
      if(ch==='"') inQ=true;
      else if(ch===delimiter) pushF();
      else if(ch==='\r'){}
      else if(ch==='\n'){ pushF(); pushR(); }
      else field+=ch;
    }
    i++;
  }
  if(field.length>0||row.length>0){ pushF(); pushR(); }
  while(rows.length && rows[rows.length-1].every(c=>String(c).trim()==="")) rows.pop();
  if(!rows.length) return {headers:[], data:[]};
  const headers = rows[0];
  const data = rows.slice(1).map(r=>{ const o={}; headers.forEach((h,idx)=>o[h]=r[idx]??""); return o; });
  return {headers,data};
}

const norm = (s)=> String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();

// === SORT
function parseForSort(val, type){
  if(val==null) return 0;
  switch(type){
    case 'number': return Number(val) || 0;
    case 'currency': return parseNumBR(val) || 0;
    case 'percent': return Number(String(val).replace('%','').replace(',','.')) || 0;
    case 'date': return parseDateFlexible(val)?.getTime() || -Infinity;
    default:
      return String(val).normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
  }
}
function sortRows(rows, key, dir, type){
  const m=dir==='asc'?1:-1;
  return rows.slice().sort((a,b)=>{
    const av=a[key], bv=b[key];
    const emptyA=av==null||av===''||av==='—';
    const emptyB=bv==null||bv===''||bv==='—';
    if(emptyA && emptyB) return 0;
    if(emptyA) return 1;
    if(emptyB) return -1;
    const A=parseForSort(av,type);
    const B=parseForSort(bv,type);
    if(A===B) return 0;
    return A>B?m:-m;
  });
}

function headerIndex(headers, label){
  const tgt = norm(label).replace(/[\.-_/]/g,'');
  for(let i=0;i<headers.length;i++){
    const h = norm(headers[i]).replace(/[\.-_/]/g,'');
    if(h===tgt) return i;
  }
  for(let i=0;i<headers.length;i++){
    const h = norm(headers[i]).replace(/[\.-_/]/g,'');
    if(h.startsWith(tgt)) return i;
  }
  return -1;
}

function detectType(h){
  const l=h.toLowerCase();
  if(l.includes('valor')||l.includes('saldo')) return 'currency';
  if(l.includes('%')||l.includes('lucro')) return 'percent';
  if(l.includes('venc')||l.includes('emiss')||l.includes('pag')||l.includes('mês')||l.includes('mes')||l.includes('data')) return 'date';
  if(l.includes('qtde')||l.includes('dias')||l.includes('ano')||l.includes('num')) return 'number';
  return 'string';
}

function makeTable(headers, rows, opts={}){
  const container = document.createElement('div');
  container.style.maxHeight='420px';
  container.style.overflow='auto';
  let html='<table><thead><tr>';
  headers.forEach((h)=>{
    const type=detectType(h);
    const sortKey=opts.tableId? state.sort[TABLE_SORT_KEYS[opts.tableId]]:null;
    const active=sortKey && sortKey.key===h;
    const dir=active? sortKey.dir:null;
    const aria=active?(dir==='asc'?'ascending':'descending'):'none';
    const cls=active?(dir==='asc'?'sort-asc':'sort-desc'):'';
    html+=`<th${opts.sortable?` data-key="${h}" data-type="${type}"`:''} class="${cls}" aria-sort="${aria}">${h}</th>`;
  });
  html+='</tr></thead><tbody>';
  rows.forEach((r,idx)=>{ html+=`<tr data-row-index="${idx}">`+headers.map(h=>`<td>${r[h]??''}</td>`).join('')+"</tr>"; });
  html+='</tbody></table>';
  container.innerHTML=html;
  if(opts.sortable){
    const thead=container.querySelector('thead');
    thead.addEventListener('click',(e)=>{
      const th=e.target.closest('th[data-key]');
      if(!th) return;
      const key=th.dataset.key; const type=th.dataset.type||'string';
      toggleSortForTable(opts.tableId, key, type);
    });
  }
  return container;
}

function groupBy(arr, keyFn){
  const m=new Map();
  for(const it of arr){ const k=keyFn(it); m.set(k,(m.get(k)||[]).concat([it])); }
  return m;
}

const _MiniChartOld = (()=>{
  function niceScale(maxAbs){
    if(maxAbs<=0) return {max:0,ticks:[0]};
    const exp=Math.floor(Math.log10(maxAbs));
    const base=Math.pow(10,exp);
    const frac=maxAbs/base; let step=base;
    if(frac>5) step=5*base; else if(frac>2) step=2*base;
    const max=Math.ceil(maxAbs/step)*step;
    const ticks=[]; for(let v=0; v<=max; v+=step) ticks.push(v);
    return {max,ticks};
  }
  function mount(canvas,cfg,opt={}){
    const ctx=canvas.getContext('2d');
    const tooltip=document.createElement('div'); tooltip.className='chart-tooltip hidden';
    canvas.parentNode.style.position='relative'; canvas.parentNode.appendChild(tooltip);
    let state={cfg:null,hidden:new Set(),legend:[],start:0};
    function size(){ const dpr=(window.devicePixelRatio||1)*(opt.scale||1); const w=canvas.clientWidth,h=canvas.clientHeight; canvas.width=w*dpr; canvas.height=h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
    const fmt=(v,u)=>u==='money'?fmtCurrencyBR(v):u==='percent'?fmtPercent(v):v;
    function draw(ts){ if(!state.cfg){ctx.clearRect(0,0,canvas.width,canvas.height);return;} size(); const {labels,datasets,type}=state.cfg; const dpr=window.devicePixelRatio||1; const w=canvas.width/dpr,h=canvas.height/dpr; ctx.clearRect(0,0,w,h); if(!labels.length){ctx.fillStyle='var(--muted)';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Sem dados no período',w/2,h/2);return;} const vis=datasets.filter(d=>!state.hidden.has(d.name)); if(!vis.length){ctx.fillStyle='var(--muted)';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Sem dados no período',w/2,h/2);return;} const pad=40,innerW=w-pad*2,innerH=h-pad*2; const scale=niceScale(Math.max(...vis.flatMap(s=>s.data.map(v=>Math.abs(v))),0)); ctx.strokeStyle='var(--text)'; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke(); ctx.textAlign='right'; ctx.textBaseline='middle'; ctx.fillStyle='var(--muted)'; scale.ticks.forEach(t=>{const y=h-pad-(t/scale.max)*innerH; ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke(); ctx.fillText(fmt(t,vis[0].unit),pad-4,y);}); ctx.textAlign='center'; ctx.textBaseline='top'; const stepX=innerW/labels.length; const rot=labels.length>8; labels.forEach((lab,i)=>{const x=pad+i*stepX+stepX/2,y=h-pad+4; if(rot){ctx.save();ctx.translate(x,y);ctx.rotate(-Math.PI/6);ctx.fillText(lab,0,0);ctx.restore();} else ctx.fillText(lab,x,y);}); let prog=1; if(state.start){const t=Math.min(1,(ts-state.start)/300); prog=t; if(t<1) requestAnimationFrame(draw); else state.start=0;} const ptsDs=[]; if(type==='bar'){const bw=stepX/vis.length*0.8,off=stepX/vis.length; vis.forEach((ds,si)=>{ctx.fillStyle=ds.color; const pts=[]; ds.data.forEach((v,i)=>{const val=v*prog; const x=pad+i*stepX+off*si+(off-bw)/2; const bh=scale.max?(val/scale.max)*innerH:0; const y=h-pad-bh; ctx.fillRect(x,y,bw,bh); pts.push({x:x+bw/2,y,v});}); ptsDs.push({ds,pts});});} else {vis.forEach(ds=>{ctx.strokeStyle=ds.color; ctx.beginPath(); const pts=[]; ds.data.forEach((v,i)=>{const val=v*prog; const x=pad+i*stepX+stepX/2; const y=h-pad-(val/scale.max)*innerH; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); pts.push({x,y,v});}); ctx.stroke(); ctx.fillStyle=ds.color; pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fill();}); ptsDs.push({ds,pts});});}
    ctx.fillStyle='var(--text)'; ctx.font='10px sans-serif'; ctx.textBaseline='bottom'; ctx.textAlign='center'; ptsDs.forEach(({ds,pts})=>{const showAll=pts.length<=12; let sel=pts; if(!showAll){const maxP=pts.reduce((m,p)=>p.v>m.v?p:m,pts[0]); const minP=pts.reduce((m,p)=>p.v<m.v?p:m,pts[0]); sel=[maxP,minP,pts[pts.length-1]];} sel.forEach(p=>ctx.fillText(fmt(p.v,ds.unit),p.x,p.y-4));}); ctx.font='12px sans-serif'; ctx.textBaseline='middle'; let lx=10,ly=10; state.legend=[]; datasets.forEach(ds=>{const wt=ctx.measureText(ds.name).width; state.legend.push({x:lx,y:ly,w:wt+24,name:ds.name}); ctx.fillStyle=ds.color; ctx.fillRect(lx,ly-6,12,12); ctx.fillStyle=state.hidden.has(ds.name)?'var(--muted)':'var(--text)'; ctx.fillText(ds.name,lx+16,ly); lx+=wt+30;}); }
    canvas.addEventListener('click',e=>{const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left,y=e.clientY-r.top; const item=state.legend.find(l=>x>=l.x && x<=l.x+l.w && y>=l.y-10 && y<=l.y+10); if(item){ if(state.hidden.has(item.name)) state.hidden.delete(item.name); else state.hidden.add(item.name); state.start=performance.now(); draw(state.start); e.stopPropagation(); }});
    canvas.addEventListener('mousemove',e=>{const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left,y=e.clientY-r.top; const {labels,datasets}=state.cfg||{}; if(!labels){tooltip.classList.add('hidden');return;} const pad=40; const step=(canvas.clientWidth-pad*2)/labels.length; const idx=Math.floor((x-pad)/step); if(idx<0||idx>=labels.length){tooltip.classList.add('hidden');return;} const lines=datasets.filter(d=>!state.hidden.has(d.name)).map(d=>`${d.name}: ${fmt(d.data[idx],d.unit)}`); if(!lines.length){tooltip.classList.add('hidden');return;} tooltip.innerHTML=`<b>${labels[idx]}</b><br>`+lines.join('<br>'); tooltip.style.left=`${x+10}px`; tooltip.style.top=`${y+10}px`; tooltip.classList.remove('hidden');});
    canvas.addEventListener('mouseleave',()=>tooltip.classList.add('hidden'));
    window.addEventListener('resize',()=>draw());
    function setCfg(c){state.cfg=c; state.start=performance.now(); draw(state.start);} setCfg(cfg||{labels:[],datasets:[],type:'bar'});
    return {update:setCfg,getConfig:()=>state.cfg};
  }
  return {mount,niceScale};
})();
// === CHARTS LEGÍVEIS
const MiniChart = (()=>{
  function niceScale(maxAbs, maxTicks=6){
    const nice=[1,2,5];
    if(maxAbs<=0) return {step:1,max:1,ticks:[0,1]};
    const mag=Math.pow(10, Math.floor(Math.log10(maxAbs)));
    let step=mag;
    for(const f of nice){ const s=f*mag; if(maxAbs/s <= maxTicks){ step=s; break; } }
    const top=Math.ceil(maxAbs/step)*step;
    const ticks=[]; for(let t=0;t<=top+1e-9;t+=step) ticks.push(t);
    return {step,max:top,ticks};
  }
  const INST=new WeakMap();
  function mount(canvas,cfg={},opt={}){
    const ctx=canvas.getContext('2d');
    const tooltip=document.createElement('div'); tooltip.className='chart-tooltip hidden';
    canvas.parentElement.style.position='relative'; canvas.parentElement.appendChild(tooltip);
    const state={cfg:null,hidden:new Set(),legend:[],hover:null,opts:{dataLabels:'auto',...opt},points:[]};
    const margins={top:36,right:16,bottom:52,left:64};
    const ro=new ResizeObserver(()=>draw()); ro.observe(canvas);
    function fmtFull(v,u){return u==='money'?fmtCurrencyBR(v):u==='percent'?fmtPercent(v):v;}
    function fmtShort(v,u){return u==='money'?fmtCurrencyCompactBR(v):u==='percent'?fmtPercent(v):v;}
    function fit(){ const dpr=window.devicePixelRatio||1; const w=canvas.clientWidth,h=canvas.clientHeight; canvas.width=w*dpr; canvas.height=h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
    function draw(){
      fit(); const cfg=state.cfg; const dpr=window.devicePixelRatio||1; const w=canvas.width/dpr,h=canvas.height/dpr;
      ctx.clearRect(0,0,w,h);
      if(!cfg || !cfg.labels.length){ ctx.fillStyle='var(--muted)'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('Sem dados no período',w/2,h/2); return; }
      const vis=cfg.datasets.filter(d=>!state.hidden.has(d.name));
      if(!vis.length){ ctx.fillStyle='var(--muted)'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('Sem dados no período',w/2,h/2); return; }
      const innerW=w-margins.left-margins.right; const innerH=h-margins.top-margins.bottom;
      const maxAbs=Math.max(...vis.flatMap(s=>s.data.map(v=>Math.abs(v))),0);
      const scale=niceScale(maxAbs,6);
      ctx.strokeStyle='var(--text)'; ctx.beginPath(); ctx.moveTo(margins.left,margins.top); ctx.lineTo(margins.left,h-margins.bottom); ctx.lineTo(w-margins.right,h-margins.bottom); ctx.stroke();
      ctx.textAlign='right'; ctx.textBaseline='middle'; ctx.fillStyle='var(--muted)'; ctx.font='11px sans-serif';
      scale.ticks.forEach(t=>{ const y=h-margins.bottom-(t/scale.max)*innerH; ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.beginPath(); ctx.moveTo(margins.left,y); ctx.lineTo(w-margins.right,y); ctx.stroke(); ctx.fillText(fmtFull(t,vis[0].unit),margins.left-4,y); });
      const stepX=innerW/cfg.labels.length; const skip=cfg.labels.length>10?Math.ceil(cfg.labels.length/10):1; ctx.textAlign='center'; ctx.textBaseline='top';
      cfg.labels.forEach((lab,i)=>{ if(i%skip!==0) return; const x=margins.left+i*stepX+stepX/2; const y=h-margins.bottom+6; if(skip>1){ ctx.save(); ctx.translate(x,y); ctx.rotate(-Math.PI/6); ctx.fillText(lab,0,0); ctx.restore(); } else ctx.fillText(lab,x,y); });
      const ptsDs=[];
      if(cfg.type==='bar'){
        const bw=stepX*0.8/vis.length; const off=stepX/vis.length;
        vis.forEach((ds,si)=>{ ctx.fillStyle=ds.color; const pts=[]; ds.data.forEach((v,i)=>{ const x=margins.left+i*stepX+off*si+(off-bw)/2; const bh=scale.max?(v/scale.max)*innerH:0; const y=h-margins.bottom-bh; ctx.fillRect(x,y,bw,bh); pts.push({x:x+bw/2,y,v}); }); ptsDs.push({ds,pts}); });
      } else {
        vis.forEach(ds=>{ ctx.strokeStyle=ds.color; ctx.lineWidth=2; ctx.beginPath(); const pts=[]; ds.data.forEach((v,i)=>{ const x=margins.left+i*stepX+stepX/2; const y=h-margins.bottom-(v/scale.max)*innerH; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); pts.push({x,y,v}); }); ctx.stroke(); ctx.fillStyle=ds.color; pts.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill();}); ptsDs.push({ds,pts}); });
      }
      ctx.font='12px sans-serif'; ctx.textBaseline='middle'; ctx.textAlign='left'; let lx=w-margins.right; const ly=margins.top-20; state.legend=[];
      cfg.datasets.forEach(ds=>{ const wt=ctx.measureText(ds.name).width; lx-=wt+24; state.legend.push({x:lx,y:ly,w:wt+24,name:ds.name}); ctx.fillStyle=ds.color; ctx.fillRect(lx,ly-6,12,12); ctx.fillStyle=state.hidden.has(ds.name)?'var(--muted)':'var(--text)'; ctx.fillText(ds.name,lx+16,ly); });
      ctx.font='11px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='bottom'; const labels=[];
      ptsDs.forEach(({ds,pts})=>{ const stepOk=stepX>=24; const policy=state.opts.dataLabels||'auto'; const maxP=pts.reduce((m,p)=>p.v>m.v?p:m,pts[0]); const minP=pts.reduce((m,p)=>p.v<m.v?p:m,pts[0]); const lastP=pts[pts.length-1]; pts.forEach((p,i)=>{ let pr=3; if(state.hover && state.hover.ds===ds && state.hover.i===i) pr=0; else if(p===maxP||p===minP||p===lastP) pr=1; if(state.opts.dataLabels==='none') return; if(policy==='auto' && pr>1 && !stepOk) return; labels.push({x:p.x,y:p.y-4,text:fmtShort(p.v,ds.unit),priority:pr}); }); });
      labels.sort((a,b)=>a.priority-b.priority); const placed=[]; labels.forEach(l=>{ if(placed.some(p=>Math.abs(p.y-l.y)<12 && Math.abs(p.x-l.x)<24 && p.priority<=l.priority)) return; ctx.fillStyle='var(--text)'; ctx.fillText(l.text,l.x,l.y); placed.push(l); });
      state.points=ptsDs;
      if(state.hover){ const {ds,i}=state.hover; const pt=ptsDs.find(p=>p.ds===ds).pts[i]; tooltip.innerHTML=`<b>${cfg.labels[i]}</b><br>${ds.name}: ${fmtFull(ds.data[i],ds.unit)}`; tooltip.style.left=pt.x+10+'px'; tooltip.style.top=pt.y+10+'px'; tooltip.classList.remove('hidden'); } else tooltip.classList.add('hidden');
    }
    function setCfg(c){ state.cfg=c; draw(); }
    function onMove(e){ const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left; const y=e.clientY-r.top; state.hover=null; state.points.forEach(({ds,pts})=>{ pts.forEach((p,i)=>{ if(Math.hypot(p.x-x,p.y-y)<=6) state.hover={ds,i}; }); }); draw(); }
    function onLeave(){ state.hover=null; draw(); }
    function onClick(e){ const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left; const y=e.clientY-r.top; const item=state.legend.find(l=>x>=l.x && x<=l.x+l.w && y>=l.y-10 && y<=l.y+10); if(item){ if(state.hidden.has(item.name)) state.hidden.delete(item.name); else state.hidden.add(item.name); draw(); } }
    canvas.addEventListener('mousemove',onMove); canvas.addEventListener('mouseleave',onLeave); canvas.addEventListener('click',onClick);
    setCfg(cfg);
    const inst={update:setCfg,getConfig:()=>state.cfg,draw,onMove,onLeave,onClick,ro,tooltip}; INST.set(canvas,inst); return inst;
  }
  function unmount(canvas){ const inst=INST.get(canvas); if(!inst) return; canvas.removeEventListener('mousemove',inst.onMove); canvas.removeEventListener('mouseleave',inst.onLeave); canvas.removeEventListener('click',inst.onClick); inst.ro.disconnect(); inst.tooltip.remove(); INST.delete(canvas); }
  function redraw(canvas){ const inst=INST.get(canvas); if(inst) inst.draw(); }
  return {mount,unmount,niceScale,redraw};
})();
// === Séries mensais ===
function computeMonthlySeries(rows, baseKey){
  const map = new Map();
  rows.forEach(r=>{
    const m = r[baseKey];
    if(!m) return;
    const o = map.get(m) || {recPrev:0,pagPrev:0,recReal:0,pagReal:0};
    if(r.tipo==='Receber'){ o.recPrev += r.valorPrev||0; o.recReal += r.valorReal||0; }
    else if(r.tipo==='Pagar'){ o.pagPrev += r.valorPrev||0; o.pagReal += r.valorReal||0; }
    map.set(m,o);
  });
  return map;
}

function seriesResultadoPorMes(monthMap){
  const base = elBase.value;
  const meses = Array.from(monthMap.keys()).sort();
  const vals = meses.map(m=>{
    const o = monthMap.get(m);
    const rec = base==='pag'? o.recReal : o.recPrev;
    const pag = base==='pag'? o.pagReal : o.pagPrev;
    return rec - pag;
  });
  return {labels:meses, values:vals};
}

function seriesPagarReceberPorMes(monthMap){
  const base = elBase.value;
  const meses = Array.from(monthMap.keys()).sort();
  const rec = meses.map(m=> base==='pag'? monthMap.get(m).recReal : monthMap.get(m).recPrev);
  const pag = meses.map(m=> base==='pag'? monthMap.get(m).pagReal : monthMap.get(m).pagPrev);
  return {labels:meses, rec, pag};
}

function seriesAcumulado(resSerie){
  let s=0; const vals = resSerie.values.map(v=> (s+=v));
  return {labels:resSerie.labels, values:vals};
}

function seriesLucratividadeMes(recSerie, resSerie){
  const vals = resSerie.labels.map((_,i)=> recSerie.rec[i]>0? (resSerie.values[i]/recSerie.rec[i]*100):0);
  return {labels:resSerie.labels, values:vals};
}

// === MENSAL
function buildMensalOptions(rows, baseKey){
  const set = new Set();
  rows.forEach(r=>{ const k = r[baseKey]; if(k) set.add(k); });
  return Array.from(set).sort().map(m=>({key:m, label:`${m.slice(5,7)}/${m.slice(0,4)}`}));
}

function renderMensalView(){
  const base = elBase.value;
  const baseKey = base==='pag'? 'mes_pag' : (base==='emiss'? 'mes_emiss' : 'mes_venc');
  const rows = state.rows || [];
  const rowsMes = rows.filter(r=> r[baseKey]===state.mensalKey);
  const mm = computeMonthlySeries(rowsMes, baseKey);
  const prM = seriesPagarReceberPorMes(mm);
  const resM = seriesResultadoPorMes(mm);
  const totRecM = prM.rec.reduce((a,b)=>a+b,0);
  const totPagM = prM.pag.reduce((a,b)=>a+b,0);
  const resValM = totRecM - totPagM;
  const lucM = totRecM>0? resValM/totRecM*100 : null;
  kResM.textContent = fmtBRL(resValM);
  kPagM.textContent = fmtBRL(totPagM);
  kRecM.textContent = fmtBRL(totRecM);
  kLucM.textContent = lucM!=null? lucM.toFixed(2)+'%' : '—';
  const recM = makeReceberTable(rowsMes);
  renderTable('tblMensalRec', recM.headers, recM.rows, {sortable:true,onRowClick:(r,i)=> openLineModal(recM.orig[i])});
  document.getElementById('recMensalStats').textContent=`${recM.rows.length||0} linhas`;
  const pagM = makePagarTable(rowsMes);
  renderTable('tblMensalPag', pagM.headers, pagM.rows, {sortable:true,onRowClick:(r,i)=> openLineModal(pagM.orig[i])});
  document.getElementById('pagMensalStats').textContent=`${pagM.rows.length||0} linhas`;
}

// === MODAL
function renderRecordDetailHTML(r){
  const rows=[
    ['Tipo', r.tipo],
    ['Doc', r.docCode?`${r.docCode} – ${r.docLabel}`:''],
    ['Situação', r.sitLabel],
    ['Emissão', fmtDateBR(r.emissao)],
    ['Vencimento', fmtDateBR(r.venc)],
    ['Pagamento', fmtDateBR(r.pag)],
    ['Contraparte', r.contraparte],
    ['Descrição', r.desc],
    ['Plano', r.plano],
    ['Centro', r.centro],
    ['Valor Previsto', fmtBRL(r.valorPrev||0)],
    ['Valor Realizado', r.valorReal!=null? fmtBRL(r.valorReal):''],
    ['Atraso (dias)', r.diasAtraso!=null? r.diasAtraso: '']
  ];
  return rows.map(([k,v])=>`<div><b>${k}:</b> ${v||''}</div>`).join('');
}

function openLineModal(rec){
  const el=document.getElementById('rowModalBody');
  el.innerHTML=renderRecordDetailHTML(rec);
  document.getElementById('rowModal').classList.remove('hidden');
}
function closeLineModal(){
  document.getElementById('rowModal').classList.add('hidden');
}
document.getElementById('rowModalClose').onclick=closeLineModal;
document.getElementById('btnCloseModal').onclick=closeLineModal;
document.querySelector('#rowModal [data-close]').onclick=closeLineModal;
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeLineModal(); });
document.getElementById('btnCopyModal').onclick=()=>{
  const txt=document.getElementById('rowModalBody').innerText;
  navigator.clipboard?.writeText(txt);
};

// === Relatório de Caixa ===
function computeCashflowTable(rows, openingBalance){
  const map = computeMonthlySeries(rows, 'mes_pag');
  const meses = Array.from(map.keys()).sort();
  const headers = ['Categoria', ...meses];
  const saldoInicial = {Categoria:'Saldo inicial do mês'};
  const receita = {Categoria:'Receita (realizada)'};
  const despesa = {Categoria:'Despesa (realizada)'};
  const resultado = {Categoria:'Resultado (R$)'};
  const acumulado = {Categoria:'Acumulado (R$)'};
  const lucro = {Categoria:'Lucro (%)'};
  let saldo = openingBalance||0;
  meses.forEach(m=>{
    const o = map.get(m)||{recReal:0,pagReal:0};
    saldoInicial[m]=fmtBRL(saldo);
    receita[m]=fmtBRL(o.recReal);
    despesa[m]=fmtBRL(o.pagReal);
    const res = o.recReal - o.pagReal;
    resultado[m]=fmtBRL(res);
    saldo += res;
    acumulado[m]=fmtBRL(saldo);
    lucro[m]= o.recReal>0? (res/o.recReal*100).toFixed(2)+'%':'—';
  });
  return {headers, rows:[saldoInicial, receita, despesa, resultado, acumulado, lucro]};
}

// === Diagnóstico ===
function computeDiagnostics(rows){
  const base = elBase.value;
  const baseDate = (r)=> base==='pag'? r.pag : base==='emiss'? r.emissao : r.venc;
  const semDataBase = rows.filter(r=> !baseDate(r));
  const docDesconhecido = rows.filter(r=> !DOC_MAP[r.docCode]);
  const sitDesconhecida = rows.filter(r=> !SIT_MAP[r.sitCode]);
  const valorAnomalo = rows.filter(r=> (r.valorPrev||0)<=0 || (r.valorReal!=null && r.valorReal<=0));
  const g = groupBy(rows, r=> `${r.docCode}|${r.contraparte}|${baseDate(r)?fmtDate(baseDate(r)):'?'}|${base==='pag'? (r.valorReal||0):(r.valorPrev||0)}`);
  const possiveisDuplicidades = Array.from(g.values()).filter(v=>v.length>1).flat();
  return {
    semDataBase, docDesconhecido, sitDesconhecida, valorAnomalo, possiveisDuplicidades,
    totals:{
      semDataBase: semDataBase.length,
      docDesconhecido: docDesconhecido.length,
      sitDesconhecida: sitDesconhecida.length,
      valorAnomalo: valorAnomalo.length,
      possiveisDuplicidades: possiveisDuplicidades.length
    }
  };
}

// ====== State ======
let RAW={headers:[], data:[]};
let REG=[]; // registros normalizados
let LAST_DET=null, LAST_CF=null;
const state = {mensalKey:'', rows:[], sort:{
  recebereTable:{key:null,dir:'asc'},
  pagarTable:{key:null,dir:'asc'},
  totalTable:{key:null,dir:'asc'},
  mensalRecTable:{key:null,dir:'asc'},
  mensalPagTable:{key:null,dir:'asc'}
}}; // === MENSAL & SORT
const TABLE_SORT_KEYS={
  tblReceber:'recebereTable',
  tblPagar:'pagarTable',
  tblMeses:'totalTable',
  tblMensalRec:'mensalRecTable',
  tblMensalPag:'mensalPagTable'
};
const tableData=new Map();

function toggleSortForTable(tableId, key, type){
  const sk=TABLE_SORT_KEYS[tableId];
  if(!sk) return;
  const st=state.sort[sk];
  if(st.key===key){ st.dir = st.dir==='asc'?'desc':'asc'; }
  else { st.key=key; st.dir='asc'; }
  st.type=type;
  refreshTableById(tableId);
}

function refreshTableById(id){
  const dat=tableData.get(id);
  if(dat) renderTable(id, dat.headers, dat.rows, dat.opts);
}

// === CHART MODAL
const chartRegistry = new Map();
function storeChartInstance(id, inst){ chartRegistry.set(id, inst); }

function toCSV(labels, datasets){
  const header=['Label',...datasets.map(d=>d.name)].join(';');
  const rows=labels.map((lab,i)=>[lab,...datasets.map(d=>d.data[i])].join(';'));
  return [header,...rows].join('\n');
}

// === CHART MODAL FIX
function fitCanvasToParent(canvas, ratio=0.6){
  const p=canvas.parentElement;
  const w=Math.max(320,p.clientWidth);
  const h=Math.max(300,Math.floor(w*ratio));
  const dpr=window.devicePixelRatio||1;
  canvas.width=Math.floor(w*dpr);
  canvas.height=Math.floor(h*dpr);
  canvas.style.width=w+'px';
  canvas.style.height=h+'px';
}

function openChartModal(fromCanvasId){
  const inst=chartRegistry.get(fromCanvasId);
  if(!inst) return;
  const cfg=structuredClone(inst.getConfig());
  const modal=document.getElementById('chartModal');
  modal.classList.remove('hidden');
  requestAnimationFrame(()=>{
    const canvas=document.getElementById('chartModalCanvas');
    MiniChart.unmount(canvas);
    fitCanvasToParent(canvas,0.6);
    MiniChart.mount(canvas,cfg,{dataLabels:'all'});
    document.getElementById('btnChartDownload').onclick=()=>{
      const url=canvas.toDataURL('image/png');
      const a=document.createElement('a'); a.href=url; a.download='grafico.png'; a.click();
    };
    document.getElementById('btnChartCopyCSV').onclick=()=>{
      const csv=toCSV(cfg.labels,cfg.datasets);
      navigator.clipboard?.writeText(csv);
    };
  });
}

function closeChartModal(){
  const modal=document.getElementById('chartModal');
  const canvas=document.getElementById('chartModalCanvas');
  MiniChart.unmount(canvas);
  modal.classList.add('hidden');
}
document.getElementById('chartModalClose').onclick=closeChartModal;
document.querySelector('#chartModal .modal-backdrop').onclick=closeChartModal;
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeChartModal(); });

// ====== Normalização ======
function toRecord(row, headers){
  const get = (label)=>{
    const i = headerIndex(headers, label);
    return i>=0 ? row[headers[i]] : '';
  };
  const tipo0 = get('Tipo')||'';
  const tipo = tipo0 || (get('Devedor')? 'Receber' : (get('Beneficiado')? 'Pagar' : ''));
  const docCode = String(get('Doc.')||'').toUpperCase().trim();
  const docLabel = DOC_MAP[docCode] || docCode || '';
  const sitCode = String(get('Situação')||'').toUpperCase().trim();
  const sitLabel = SIT_MAP[sitCode] || sitCode || '';

  const emissao = parseDateFlexible(get('Emissão'));
  const venc = parseDateFlexible(get('Vencimento'));
  const pag = parseDateFlexible(get('Pagamento'));

  // valores
  const vValor = parseNumBR(get('Valor'));
  const vTot = parseNumBR(get('Total'));
  const vTLiq = parseNumBR(get('Total Liquido'));
  const vTRec = parseNumBR(get('Total a Receber'));

  const isRec = tipo==='Receber';
  const isPag = tipo==='Pagar';

  const valorPrev = isRec ? (vTRec ?? vTLiq ?? vValor) : (vTot ?? vValor);
  const valorReal = (pag? (isRec ? (vTLiq ?? vValor) : (vValor ?? vTot)) : null);

  // status padronizado
  let statusPad = sitLabel||''; // Aberto ou Liquidado se vier mapeado
  if(statusPad===''){ statusPad = pag? 'Liquidado' : 'Aberto'; }

  const hoje = new Date(); hoje.setHours(0,0,0,0);
  let diasAtraso = null, diasAteVenc = null;
  if(venc){ diasAteVenc = Math.round((venc - (emissao||venc))/86400000); }
  if(statusPad==='Aberto'){
    if(venc){
      const diff = Math.round((hoje - venc)/86400000);
      diasAtraso = Math.max(0, diff);
      if(diasAtraso>0) statusPad = 'Atrasado';
    }
  } else if(pag && venc){
    const diff = Math.round((pag - venc)/86400000);
    diasAtraso = Math.max(0, diff);
  }

  const contraparte = isRec ? (get('Devedor')||'') : (get('Beneficiado')||'');
  const plano = get('Plano de contas')||'';
  const centro = get('Centro de contas')||'';
  const desc = get('Descrição')||'';

  return {
    tipo, docCode, docLabel, sitCode, sitLabel: statusPad,
    emissao, venc, pag,
    valorPrev, valorReal,
    contraparte, plano, centro, desc,
    diasAtraso, diasAteVenc,
    mes_emiss: emissao? `${emissao.getFullYear()}-${pad2(emissao.getMonth()+1)}` : '',
    mes_venc: venc? `${venc.getFullYear()}-${pad2(venc.getMonth()+1)}` : '',
    mes_pag: pag? `${pag.getFullYear()}-${pad2(pag.getMonth()+1)}` : ''
  };
}

// ====== Render Utils ======
function renderTable(containerId, headers, rows, opts={}){
  tableData.set(containerId,{headers, rows, opts});
  const c = document.getElementById(containerId);
  c.innerHTML = '';
  let viewRows = rows;
  if(opts.sortable){
    const sk=TABLE_SORT_KEYS[containerId];
    const st=state.sort[sk];
    if(st && st.key){ viewRows = sortRows(viewRows, st.key, st.dir, st.type||detectType(st.key)); }
  }
  const table = makeTable(headers, viewRows, {sortable:opts.sortable, tableId:containerId});
  c.appendChild(table);
  if(opts.onRowClick){
    c.onclick = (e)=>{
      const tr = e.target.closest('tr[data-row-index]');
      if(!tr) return;
      const idx = +tr.dataset.rowIndex;
      const origIdx = rows.indexOf(viewRows[idx]);
      opts.onRowClick(viewRows[idx], origIdx, tr);
    };
    c.querySelectorAll('tbody tr').forEach(tr=> tr.style.cursor='pointer');
  }
}

function sum(arr, sel){ let s=0; for(const x of arr){ const v=sel(x); if(typeof v==='number' && isFinite(v)) s+=v; } return s; }

function applyFilters(base, dtIni, dtFim, tipo, sit, doc, busca){
  return REG.filter(r=>{
    // base de período
    let dBase = r.venc; if(base==='emiss') dBase=r.emissao; if(base==='pag') dBase=r.pag;
    if(dtIni && (!dBase || dBase<dtIni)) return false;
    if(dtFim && (!dBase || dBase>dtFim)) return false;
    if(tipo && r.tipo!==tipo) return false;
    if(sit && r.sitLabel!==sit) return false;
    if(doc && r.docCode!==doc) return false;
    if(busca){
      const q = norm(busca);
      const hay = [r.contraparte, r.desc, r.plano, r.centro].map(norm).join(' ');
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}

function makeMesesResumo(rows, base){
  const key = base==='emiss'?'mes_emiss': base==='pag'?'mes_pag':'mes_venc';
  const g = groupBy(rows, r=> r[key]||'(sem mês)');
  const meses = Array.from(g.keys()).sort();
  const out = [];
  for(const m of meses){
    const arr = g.get(m);
    const recPrev = sum(arr.filter(r=>r.tipo==='Receber'), r=> r.valorPrev||0);
    const pagPrev = sum(arr.filter(r=>r.tipo==='Pagar'), r=> r.valorPrev||0);
    const recReal = sum(arr.filter(r=>r.tipo==='Receber'), r=> r.valorReal||0);
    const pagReal = sum(arr.filter(r=>r.tipo==='Pagar'), r=> r.valorReal||0);
    out.push({
      Mês:m,
      "Previsto Receber": fmtBRL(recPrev),
      "Previsto Pagar": fmtBRL(pagPrev),
      "Saldo Previsto": fmtBRL(recPrev - pagPrev),
      "Realizado Receber": fmtBRL(recReal),
      "Realizado Pagar": fmtBRL(pagReal),
      "Saldo Realizado": fmtBRL(recReal - pagReal),
      "Qtde": fmtInt(arr.length)
    });
  }
  return out;
}

function makeReceberTable(rows){
  const headers = ["Vencimento","Devedor","Doc.","Situação","Emissão","Pagamento","Valor Previsto","Valor Realizado","Atraso (dias)","Descrição","Plano","Centro"];
  const orig=[]; const out = rows.filter(r=>r.tipo==='Receber').map(r=>{ orig.push(r); return {
    "Vencimento": r.venc? fmtDateBR(r.venc):'',
    "Devedor": r.contraparte||'',
    "Doc.": r.docCode? `${r.docCode} – ${r.docLabel}`:'',
    "Situação": r.sitLabel,
    "Emissão": r.emissao? fmtDateBR(r.emissao):'',
    "Pagamento": r.pag? fmtDateBR(r.pag):'',
    "Valor Previsto": fmtBRL(r.valorPrev||0),
    "Valor Realizado": r.valorReal!=null? fmtBRL(r.valorReal):'',
    "Atraso (dias)": (r.sitLabel==='Atrasado' && r.diasAtraso!=null)? r.diasAtraso : (r.diasAtraso!=null? r.diasAtraso: ''),
    "Descrição": r.desc||'',
    "Plano": r.plano||'',
    "Centro": r.centro||''
  }; });
  return {headers, rows: out, orig};
}

function makePagarTable(rows){
  const headers = ["Vencimento","Beneficiado","Doc.","Situação","Emissão","Pagamento","Valor Previsto","Valor Realizado","Atraso (dias)","Descrição","Plano","Centro"];
  const orig=[]; const out = rows.filter(r=>r.tipo==='Pagar').map(r=>{ orig.push(r); return {
    "Vencimento": r.venc? fmtDateBR(r.venc):'',
    "Beneficiado": r.contraparte||'',
    "Doc.": r.docCode? `${r.docCode} – ${r.docLabel}`:'',
    "Situação": r.sitLabel,
    "Emissão": r.emissao? fmtDateBR(r.emissao):'',
    "Pagamento": r.pag? fmtDateBR(r.pag):'',
    "Valor Previsto": fmtBRL(r.valorPrev||0),
    "Valor Realizado": r.valorReal!=null? fmtBRL(r.valorReal):'',
    "Atraso (dias)": (r.sitLabel==='Atrasado' && r.diasAtraso!=null)? r.diasAtraso : (r.diasAtraso!=null? r.diasAtraso: ''),
    "Descrição": r.desc||'',
    "Plano": r.plano||'',
    "Centro": r.centro||''
  }; });
  return {headers, rows: out, orig};
}

// === REMOVER AGING

function porPlano(rows){
  const g = groupBy(rows, r=> r.plano||'(sem plano)');
  const arr = Array.from(g.entries()).map(([k,v])=>({
    Plano:k,
    "Previsto Receber": fmtBRL(sum(v.filter(x=>x.tipo==='Receber'), x=>x.valorPrev||0)),
    "Previsto Pagar": fmtBRL(sum(v.filter(x=>x.tipo==='Pagar'), x=>x.valorPrev||0)),
    "Realizado": fmtBRL(sum(v, x=>x.valorReal||0)),
    "Qtde": fmtInt(v.length)
  })).sort((a,b)=>{
    const av = parseNumBR(a["Previsto Receber"]) - parseNumBR(a["Previsto Pagar"]);
    const bv = parseNumBR(b["Previsto Receber"]) - parseNumBR(b["Previsto Pagar"]);
    return bv-av;
  });
  return {headers:["Plano","Previsto Receber","Previsto Pagar","Realizado","Qtde"], rows:arr};
}

function porCentro(rows){
  const g = groupBy(rows, r=> r.centro||'(sem centro)');
  const arr = Array.from(g.entries()).map(([k,v])=>({
    Centro:k,
    "Previsto Receber": fmtBRL(sum(v.filter(x=>x.tipo==='Receber'), x=>x.valorPrev||0)),
    "Previsto Pagar": fmtBRL(sum(v.filter(x=>x.tipo==='Pagar'), x=>x.valorPrev||0)),
    "Realizado": fmtBRL(sum(v, x=>x.valorReal||0)),
    "Qtde": fmtInt(v.length)
  })).sort((a,b)=>{
    const av = parseNumBR(a["Previsto Receber"]) - parseNumBR(a["Previsto Pagar"]);
    const bv = parseNumBR(b["Previsto Receber"]) - parseNumBR(b["Previsto Pagar"]);
    return bv-av;
  });
  return {headers:["Centro","Previsto Receber","Previsto Pagar","Realizado","Qtde"], rows:arr};
}

function detalhe(rows){
  const headers = ["Tipo","Doc.","Situação","Emissão","Vencimento","Pagamento","Contraparte","Descrição","Plano","Centro","Valor Previsto","Valor Realizado","Atraso (dias)"];
  const orig=[]; const out = rows.map(r=>{ orig.push(r); return {
    "Tipo": r.tipo,
    "Doc.": r.docCode? `${r.docCode} – ${r.docLabel}`:'',
    "Situação": r.sitLabel,
    "Emissão": r.emissao? fmtDateBR(r.emissao):'',
    "Vencimento": r.venc? fmtDateBR(r.venc):'',
    "Pagamento": r.pag? fmtDateBR(r.pag):'',
    "Contraparte": r.contraparte||'',
    "Descrição": r.desc||'',
    "Plano": r.plano||'',
    "Centro": r.centro||'',
    "Valor Previsto": fmtBRL(r.valorPrev||0),
    "Valor Realizado": r.valorReal!=null? fmtBRL(r.valorReal):'',
    "Atraso (dias)": r.diasAtraso!=null? r.diasAtraso: ''
  }; });
  return {headers, rows: out, orig};
}

function exportCSV(headers, rows){
  const delim = ';';
  const esc = (v)=>{
    let s = v==null? '' : String(v);
    const needQ = /[";\n\r]/.test(s);
    s = s.replace(/"/g,'""');
    return needQ? `"${s}"` : s;
  };
  const head = headers.map(esc).join(delim);
  const body = rows.map(r=> headers.map(h=>esc(r[h])).join(delim)).join('\r\n');
  return head + '\r\n' + body + '\r\n';
}

// ====== UI Bindings ======
const elFile = document.getElementById('fileCsv');
const elBase = document.getElementById('baseTempo');
const elIni = document.getElementById('dtIni');
const elFim = document.getElementById('dtFim');
const elTipo = document.getElementById('fTipo');
const elSit = document.getElementById('fSit');
const elDoc = document.getElementById('fDoc');
const elBusca = document.getElementById('fBusca');
const elStatus = document.getElementById('status');
const elNow = document.getElementById('now');
const kRes = document.getElementById('kResultado');
const kPag = document.getElementById('kPagar');
const kRec = document.getElementById('kReceber');
const kLuc = document.getElementById('kLucratividade');
const kResM = document.getElementById('kResM');
const kPagM = document.getElementById('kPagarM');
const kRecM = document.getElementById('kReceberM');
const kLucM = document.getElementById('kLucroM');
const mensalMesSelect = document.getElementById('mensalMesSelect');
const saldoIni = document.getElementById('saldoInicial');


function setStatus(msg, ok){
  elStatus.textContent = msg;
  elStatus.style.borderColor = ok? 'rgba(152,236,178,.5)' : 'var(--soft)';
}

function refresh(){
  if(!REG.length){ setStatus('Aguardando CSV…'); return; }
  const di = elIni.value? new Date(elIni.value) : null; if(di) di.setHours(0,0,0,0);
  const df = elFim.value? new Date(elFim.value) : null; if(df) df.setHours(23,59,59,999);
  const base = elBase.value; const tipo = elTipo.value; const sit = elSit.value; const doc = elDoc.value; const busca = elBusca.value.trim();

  const rows = applyFilters(base, di, df, tipo, sit, doc, busca);
  state.rows = rows; // === MENSAL
  const baseKey = base==='pag'? 'mes_pag' : (base==='emiss'? 'mes_emiss' : 'mes_venc');
  const monthMap = computeMonthlySeries(rows, baseKey);
  const prSeries = seriesPagarReceberPorMes(monthMap);
  const resSeries = seriesResultadoPorMes(monthMap);
  const acumSeries = seriesAcumulado(resSeries);
  const lucroSeries = seriesLucratividadeMes(prSeries, resSeries);

  const totRec = prSeries.rec.reduce((a,b)=>a+b,0);
  const totPag = prSeries.pag.reduce((a,b)=>a+b,0);
  const resultado = totRec - totPag;
  const lucr = totRec>0? resultado/totRec*100 : null;

  kRes.textContent = fmtBRL(resultado);
  kPag.textContent = fmtBRL(totPag);
  kRec.textContent = fmtBRL(totRec);
  kLuc.textContent = lucr!=null? lucr.toFixed(2)+'%' : '—';

  const fmtMes = m=>`${m.slice(5,7)}/${m.slice(2,4)}`;
  const cfgRes={type:'bar',labels:resSeries.labels.map(fmtMes),datasets:[{name:'Resultado',data:resSeries.values,unit:'money',color:'#f26722'}]};
  const cfgPVSR={type:'bar',labels:prSeries.labels.map(fmtMes),datasets:[{name:'Receber',data:prSeries.rec,unit:'money',color:'#98ecb2'},{name:'Pagar',data:prSeries.pag,unit:'money',color:'#ff9b9b'}]};
  const cfgAcum={type:'line',labels:acumSeries.labels.map(fmtMes),datasets:[{name:'Acumulado',data:acumSeries.values,unit:'money',color:'#f26722'}]};
  const cfgLuc={type:'line',labels:lucroSeries.labels.map(fmtMes),datasets:[{name:'Lucratividade',data:lucroSeries.values,unit:'percent',color:'#98ecb2'}]};
  MiniChart.unmount(document.getElementById('chResMensal'));
  storeChartInstance('chResMensal', MiniChart.mount(document.getElementById('chResMensal'), cfgRes));
  MiniChart.unmount(document.getElementById('chPVSRMensal'));
  storeChartInstance('chPVSRMensal', MiniChart.mount(document.getElementById('chPVSRMensal'), cfgPVSR));
  MiniChart.unmount(document.getElementById('chResAcum'));
  storeChartInstance('chResAcum', MiniChart.mount(document.getElementById('chResAcum'), cfgAcum));
  MiniChart.unmount(document.getElementById('chLucroMensal'));
  storeChartInstance('chLucroMensal', MiniChart.mount(document.getElementById('chLucroMensal'), cfgLuc));

  const meses = makeMesesResumo(rows, base);
  renderTable('tblMeses', Object.keys(meses[0]||{"Mês":"Mês"}), meses, {sortable:true});
  document.getElementById('infoMeses').textContent = `${rows.length||0} lançamentos no período`;

  const rec = makeReceberTable(rows);
  renderTable('tblReceber', rec.headers, rec.rows, {sortable:true,onRowClick:(r,i)=> openLineModal(rec.orig[i])});
  document.getElementById('recStats').textContent = `${rec.rows.length||0} linhas`;

  const pag = makePagarTable(rows);
  renderTable('tblPagar', pag.headers, pag.rows, {sortable:true,onRowClick:(r,i)=> openLineModal(pag.orig[i])});
  document.getElementById('pagStats').textContent = `${pag.rows.length||0} linhas`;

  const pl = porPlano(rows);
  renderTable('tblPlanos', pl.headers, pl.rows);
  const ct = porCentro(rows);
  renderTable('tblCentros', ct.headers, ct.rows);
  document.getElementById('planStats').textContent = `${pl.rows.length} planos • ${ct.rows.length} centros`;

  const det = detalhe(rows);
  renderTable('tblDetalhe', det.headers, det.rows, {onRowClick:(r,i)=> openLineModal(det.orig[i])});
  document.getElementById('detStats').textContent = `${det.rows.length||0} linhas`;
  LAST_DET = det;

  // === MENSAL
  const mensalOpts = buildMensalOptions(rows, baseKey);
  mensalMesSelect.innerHTML = mensalOpts.map(o=>`<option value="${o.key}">${o.label}</option>`).join('');
  if(state.mensalKey && mensalOpts.some(o=>o.key===state.mensalKey)){
    mensalMesSelect.value = state.mensalKey;
  } else {
    mensalMesSelect.value = mensalOpts[0]? mensalOpts[0].key : '';
    state.mensalKey = mensalMesSelect.value;
  }
  if(document.querySelector('.tab.active').dataset.tab==='mensal') renderMensalView();

  // Relatório de Caixa
  const rowsCaixa = applyFilters('pag', di, df, tipo, sit, doc, busca);
  const cf = computeCashflowTable(rowsCaixa, parseFloat(saldoIni.value)||0);
  renderTable('tblRelCaixa', cf.headers, cf.rows);
  LAST_CF = cf;

  // Diagnóstico
  const diagRows = REG.filter(r=>{
    let dBase = base==='pag'? r.pag : base==='emiss'? r.emissao : r.venc;
    if(di && dBase && dBase<di) return false;
    if(df && dBase && dBase>df) return false;
    if(tipo && r.tipo!==tipo) return false;
    if(sit && r.sitLabel!==sit) return false;
    if(doc && r.docCode!==doc) return false;
    if(busca){ const q=norm(busca); const hay=[r.contraparte,r.desc,r.plano,r.centro].map(norm).join(' '); if(!hay.includes(q)) return false; }
    return true;
  });
  const diag = computeDiagnostics(diagRows);
  document.getElementById('dSemData').textContent = diag.totals.semDataBase;
  document.getElementById('dDoc').textContent = diag.totals.docDesconhecido;
  document.getElementById('dSit').textContent = diag.totals.sitDesconhecida;
  document.getElementById('dVal').textContent = diag.totals.valorAnomalo;
  document.getElementById('dDup').textContent = diag.totals.possiveisDuplicidades;
  const diagSample = (arr)=> arr.slice(0,5).map(r=>({Tipo:r.tipo, Doc:r.docCode, Contraparte:r.contraparte, Valor:fmtBRL((r.valorReal!=null?r.valorReal:r.valorPrev)||0)}));
  renderTable('diagSemData', ['Tipo','Doc','Contraparte','Valor'], diagSample(diag.semDataBase));
  renderTable('diagDoc', ['Tipo','Doc','Contraparte','Valor'], diagSample(diag.docDesconhecido));
  renderTable('diagSit', ['Tipo','Doc','Contraparte','Valor'], diagSample(diag.sitDesconhecida));
  renderTable('diagVal', ['Tipo','Doc','Contraparte','Valor'], diagSample(diag.valorAnomalo));
  renderTable('diagDup', ['Tipo','Doc','Contraparte','Valor'], diagSample(diag.possiveisDuplicidades));

  setStatus('Ok', true);
}

elFile.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f){ setStatus('Selecione um CSV.'); return; }
  setStatus('Lendo CSV…');
  const text = await f.text();
  const parsed = parseCSV(text);
  RAW = parsed;
  REG = parsed.data.map(row=> toRecord(row, parsed.headers));
  setStatus(`CSV carregado: ${parsed.data.length} linhas.` , true);
  refresh();
});

['change','keyup'].forEach(ev=>{
  elBase.addEventListener(ev, refresh);
  elIni.addEventListener(ev, refresh);
  elFim.addEventListener(ev, refresh);
  elTipo.addEventListener(ev, refresh);
  elSit.addEventListener(ev, refresh);
  elDoc.addEventListener(ev, refresh);
  elBusca.addEventListener(ev, ()=>{ clearTimeout(window.___t); window.___t=setTimeout(refresh,200); });
});
mensalMesSelect.addEventListener('change', (e)=>{ state.mensalKey=e.target.value; renderMensalView(); });
saldoIni.addEventListener('change', refresh);
['chResMensal','chPVSRMensal','chResAcum','chLucroMensal'].forEach(id=>{
  const cv=document.getElementById(id);
  if(cv){cv.style.cursor='zoom-in'; cv.addEventListener('click',()=>openChartModal(id));}
});

// Export atual
document.getElementById('btnExport').addEventListener('click', ()=>{
   const active = document.querySelector('.tab.active').dataset.tab;
   let csv='';
   if(active==='relcaixa' && LAST_CF){
     csv = exportCSV(LAST_CF.headers, LAST_CF.rows);
   } else {
     const di = elIni.value? new Date(elIni.value) : null; if(di) di.setHours(0,0,0,0);
     const df = elFim.value? new Date(elFim.value) : null; if(df) df.setHours(23,59,59,999);
     const base = elBase.value; const tipo = elTipo.value; const sit = elSit.value; const doc = elDoc.value; const busca = elBusca.value.trim();
     const rows = applyFilters(base, di, df, tipo, sit, doc, busca);
     const det = detalhe(rows);
     csv = exportCSV(det.headers, det.rows);
   }
   const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url; a.download = 'visao_filtrada.csv'; a.click();
   setTimeout(()=> URL.revokeObjectURL(url), 1000);
 });

// Tabs
const tabsEl = document.getElementById('tabs');
const sections = {
  geral: document.getElementById('tab-geral'),
  mensal: document.getElementById('tab-mensal'),
  receber: document.getElementById('tab-receber'),
  pagar: document.getElementById('tab-pagar'),
  // === REMOVER AGING
  planos: document.getElementById('tab-planos'),
  detalhe: document.getElementById('tab-detalhe'),
  relcaixa: document.getElementById('tab-relcaixa'),
  diag: document.getElementById('tab-diag')
};

tabsEl.addEventListener('click', (e)=>{
  if(e.target.classList.contains('tab')){
    const tab = e.target.getAttribute('data-tab');
    Array.from(tabsEl.children).forEach(x=> x.classList.remove('active'));
    e.target.classList.add('active');
    Object.keys(sections).forEach(k=> sections[k].style.display='none');
    sections[tab].style.display='block';
    if(tab==='mensal') renderMensalView();
  }
});

// now label
(function(){
  const d = new Date();
  elNow.textContent = `Atualizado ${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
})();
</script>
</body>
</html>
